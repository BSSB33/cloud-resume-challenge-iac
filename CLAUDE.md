# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Cloud Resume Challenge infrastructure repository that deploys a serverless resume website using AWS services, managed entirely with Terraform. The infrastructure includes:
- Static website hosting (S3 + CloudFront + Route53)
- Dynamic view counter (Lambda + DynamoDB)
- SSL/TLS certificate management (ACM)
- All resources deployed in `eu-west-1` (except ACM in `us-east-1` for CloudFront)

## Terraform Commands

### Basic Operations
```bash
# Initialize Terraform (downloads providers, configures S3 backend)
terraform init

# View planned changes
terraform plan

# Apply changes to AWS infrastructure
terraform apply

# Destroy all infrastructure
terraform destroy

# Format all .tf files
terraform fmt -recursive

# Validate configuration
terraform validate

# Show current state
terraform show

# List all resources in state
terraform state list
```

### Targeting Specific Resources
```bash
# Apply changes to only Lambda function
terraform apply -target=aws_lambda_function.view_counter

# Apply changes to only CloudFront distribution
terraform apply -target=aws_cloudfront_distribution.cloud_resume

# Destroy only DynamoDB table
terraform destroy -target=aws_dynamodb_table.view_counter
```

### State Management
```bash
# Refresh state from AWS
terraform refresh

# Pull remote state from S3
terraform state pull

# Remove resource from state (doesn't delete from AWS)
terraform state rm <resource_address>
```

## Architecture Overview

The infrastructure follows a serverless architecture pattern with clear separation between static and dynamic content:

### Static Content Flow
1. User requests `vitraigabor.eu` → Route53 DNS
2. Route53 → CloudFront distribution (with SSL/TLS)
3. CloudFront → S3 bucket (via Origin Access Control)
4. S3 returns HTML/CSS/JS files
5. CloudFront caches at edge locations for 1 week

### Dynamic Content Flow
1. Browser JavaScript calls Lambda Function URL
2. Lambda validates CORS/Referer headers
3. Lambda performs atomic increment on DynamoDB item
4. Returns updated view count as JSON
5. JavaScript updates counter in UI

### Multi-Provider Setup
The project uses **two AWS providers**:
- **Default provider**: `eu-west-1` for most resources (S3, Lambda, DynamoDB, CloudWatch)
- **Aliased provider**: `us-east-1` for ACM certificate (CloudFront requirement)

When modifying ACM resources, always use `provider = aws.us_east_1`.

## File Structure and Responsibilities

- `provider.tf` - AWS provider configuration (dual-region setup)
- `backend.tf` - S3 remote state configuration
- `variables.tf` - Input variables (region, domain, environment)
- `main.tf` - S3 bucket for website hosting
- `website.tf` - S3 objects (HTML/CSS/JS file uploads)
- `cloudfront.tf` - CDN distribution and Origin Access Control
- `route53.tf` - DNS records (A/AAAA pointing to CloudFront)
- `acm.tf` - SSL certificate in us-east-1
- `dynamodb.tf` - View counter table
- `lambda.tf` - Lambda function, IAM roles, Function URL, CloudWatch logs
- `outputs.tf` - Output values for important resource attributes
- `lambda/view_counter.py` - Python Lambda function code

## Key Infrastructure Details

### S3 Backend State
- State stored in: `vitraiaws-cloud-resume-terraform-state` bucket
- Key: `cloud-resume-challenge/terraform.tfstate`
- Region: `eu-west-1`
- Profile: `vitraigabor`
- Encryption: Enabled

### AWS Profile
All operations use the AWS CLI profile `vitraigabor`. Ensure this profile is configured in `~/.aws/credentials` and `~/.aws/config` before running Terraform commands.

### Lambda Function
- Runtime: Python 3.12
- Handler: `lambda_function.lambda_handler`
- Timeout: 10 seconds
- Environment variables: `TABLE_NAME`, `ALLOWED_ORIGIN`
- Code location: `lambda/view_counter.py`
- Packaged as: `lambda_function.zip` (generated by Terraform)

When modifying Lambda code:
1. Edit `lambda/view_counter.py`
2. Run `terraform apply` - Terraform will automatically repackage and deploy
3. Check CloudWatch logs: `/aws/lambda/cloud-resume-view-counter`

### DynamoDB Table
- Name: `cloud-resume-view-counter`
- Partition key: `id` (String)
- Single item with `id = "1"` stores the view count
- Attribute: `views` (Number) - atomically incremented by Lambda
- Billing: On-demand (pay per request)

### CloudFront Distribution
- Origin Access Control (OAC) for S3 access (not legacy OAI)
- HTTPS only (HTTP redirects to HTTPS)
- Geo-restriction: Europe only
- Price class: 100 (EU + North America edge locations)
- Cache policy: 1 week TTL
- Default root object: `index.html`

### Tags
All resources are tagged with `cloud-resume = "true"` for easy identification and cost tracking.

## Common Development Workflows

### Updating Website Content
1. Modify HTML/CSS/JS files locally
2. Update corresponding `aws_s3_object` resources in `website.tf`
3. Run `terraform apply`
4. Invalidate CloudFront cache if needed:
   ```bash
   aws cloudfront create-invalidation --distribution-id <id> --paths "/*"
   ```

### Modifying Lambda Function
1. Edit `lambda/view_counter.py`
2. Run `terraform apply` (automatically rezips and deploys)
3. Test via Function URL or from website
4. Check logs: `aws logs tail /aws/lambda/cloud-resume-view-counter --follow`

### Adding New AWS Resources
1. Create or edit appropriate `.tf` file
2. Follow existing naming conventions (prefix with `cloud-resume-`)
3. Add `cloud-resume = "true"` tag
4. Use variables from `variables.tf` where applicable
5. Run `terraform plan` to review changes
6. Run `terraform apply` to create resources

### Troubleshooting

**CloudFront not showing updated content:**
- Check S3 bucket objects were uploaded
- Create CloudFront invalidation
- Verify CloudFront origin points to correct S3 bucket

**Lambda not responding:**
- Check CloudWatch logs: `/aws/lambda/cloud-resume-view-counter`
- Verify Function URL is public with correct CORS settings
- Check IAM role has DynamoDB permissions
- Verify environment variables are set correctly

**Certificate issues:**
- ACM certificate MUST be in `us-east-1` for CloudFront
- Check validation status in ACM console
- Ensure DNS validation records exist in Route53

**State lock errors:**
- If `terraform apply` hangs, check S3 backend for lock files
- Force unlock: `terraform force-unlock <lock-id>`

## Security Considerations

- S3 bucket is **private** (no public access)
- CloudFront uses Origin Access Control (OAC) to access S3
- Lambda Function URL is public but protected by CORS
- Lambda validates Referer header (browser-based calls only)
- All data encrypted at rest (S3, DynamoDB, Terraform state)
- TLS 1.2 minimum for CloudFront
- IAM roles follow least privilege principle

## Cost Management

Expected monthly cost: ~$0.50
- Route53 Hosted Zone: $0.50/month (only significant cost)
- All other services within AWS Free Tier limits
- Domain registration: $8-13/year (one-time annual)

To avoid unexpected charges:
- Monitor CloudFront data transfer (Free Tier: 1TB/month)
- Monitor Lambda invocations (Free Tier: 1M requests/month)
- Keep CloudWatch log retention at 7 days
